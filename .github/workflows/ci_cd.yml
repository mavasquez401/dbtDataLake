name: Data Lake CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

env:
  PYTHON_VERSION: '3.11'
  DBT_PROFILES_DIR: ${{ github.workspace }}/dbt_project

jobs:
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip packages
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install black flake8 isort sqlfluff

      - name: Run Black (Python formatter)
        run: black --check scripts/

      - name: Run isort (Import sorter)
        run: isort --check-only scripts/

      - name: Run Flake8 (Python linter)
        run: flake8 scripts/ --max-line-length=100 --exclude=__pycache__

      - name: Run SQLFluff (SQL linter)
        run: sqlfluff lint dbt_project/models/ --dialect snowflake || true

  test-python:
    name: Test Python Scripts
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov

      - name: Run Python tests
        run: |
          pytest tests/ -v --cov=scripts --cov-report=xml --cov-report=term || true

      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
        if: always()

  dbt-test:
    name: dbt Test
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dbt
        run: |
          pip install --upgrade pip
          pip install dbt-snowflake==1.7.1

      - name: Create profiles.yml
        run: |
          mkdir -p ~/.dbt
          cat > ~/.dbt/profiles.yml << EOF
          institutional_data_lake:
            target: dev
            outputs:
              dev:
                type: snowflake
                account: ${{ secrets.SNOWFLAKE_ACCOUNT }}
                user: ${{ secrets.SNOWFLAKE_USER }}
                password: ${{ secrets.SNOWFLAKE_PASSWORD }}
                role: ${{ secrets.SNOWFLAKE_ROLE }}
                database: DATA_LAKE
                warehouse: DATA_LAKE_WH
                schema: BRONZE
                threads: 4
          EOF

      - name: dbt deps
        run: cd dbt_project && dbt deps
        continue-on-error: true

      - name: dbt debug
        run: cd dbt_project && dbt debug
        continue-on-error: true

      - name: dbt compile
        run: cd dbt_project && dbt compile
        continue-on-error: true

      - name: dbt test
        run: cd dbt_project && dbt test
        continue-on-error: true

  data-quality:
    name: Data Quality Checks
    runs-on: ubuntu-latest
    needs: [test-python, dbt-test]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Great Expectations validations
        env:
          SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
          SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER }}
          SNOWFLAKE_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}
          SNOWFLAKE_ROLE: ${{ secrets.SNOWFLAKE_ROLE }}
        run: |
          python scripts/run_data_quality.py
        continue-on-error: true

      - name: Upload data quality reports
        uses: actions/upload-artifact@v3
        with:
          name: data-quality-reports
          path: data_quality/great_expectations/uncommitted/data_docs/
        if: always()

  deploy-dev:
    name: Deploy to Development
    runs-on: ubuntu-latest
    needs: [dbt-test, data-quality]
    if: github.ref == 'refs/heads/develop'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dbt
        run: |
          pip install --upgrade pip
          pip install dbt-snowflake==1.7.1

      - name: Create profiles.yml
        run: |
          mkdir -p ~/.dbt
          cat > ~/.dbt/profiles.yml << EOF
          institutional_data_lake:
            target: dev
            outputs:
              dev:
                type: snowflake
                account: ${{ secrets.SNOWFLAKE_ACCOUNT }}
                user: ${{ secrets.SNOWFLAKE_USER }}
                password: ${{ secrets.SNOWFLAKE_PASSWORD }}
                role: ${{ secrets.SNOWFLAKE_ROLE }}
                database: DATA_LAKE
                warehouse: DATA_LAKE_WH
                schema: BRONZE
                threads: 4
          EOF

      - name: dbt deps
        run: cd dbt_project && dbt deps

      - name: dbt run
        run: cd dbt_project && dbt run --target dev

      - name: dbt test
        run: cd dbt_project && dbt test --target dev

  deploy-prod:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [dbt-test, data-quality]
    if: github.ref == 'refs/heads/main'
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dbt
        run: |
          pip install --upgrade pip
          pip install dbt-snowflake==1.7.1

      - name: Create profiles.yml
        run: |
          mkdir -p ~/.dbt
          cat > ~/.dbt/profiles.yml << EOF
          institutional_data_lake:
            target: prod
            outputs:
              prod:
                type: snowflake
                account: ${{ secrets.SNOWFLAKE_ACCOUNT }}
                user: ${{ secrets.SNOWFLAKE_USER }}
                password: ${{ secrets.SNOWFLAKE_PASSWORD }}
                role: ${{ secrets.SNOWFLAKE_ROLE }}
                database: DATA_LAKE
                warehouse: DATA_LAKE_WH
                schema: GOLD
                threads: 8
          EOF

      - name: dbt deps
        run: cd dbt_project && dbt deps

      - name: dbt run
        run: cd dbt_project && dbt run --target prod

      - name: dbt test
        run: cd dbt_project && dbt test --target prod

      - name: Generate dbt docs
        run: cd dbt_project && dbt docs generate

      - name: Upload dbt docs
        uses: actions/upload-artifact@v3
        with:
          name: dbt-docs
          path: dbt_project/target/

  terraform-plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.0

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Terraform Init
        run: cd terraform && terraform init

      - name: Terraform Format Check
        run: cd terraform && terraform fmt -check

      - name: Terraform Validate
        run: cd terraform && terraform validate

      - name: Terraform Plan
        env:
          SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
          SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER }}
          SNOWFLAKE_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}
        run: cd terraform && terraform plan

  terraform-apply:
    name: Terraform Apply
    runs-on: ubuntu-latest
    needs: terraform-plan
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.0

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Terraform Init
        run: cd terraform && terraform init

      - name: Terraform Apply
        env:
          SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
          SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER }}
          SNOWFLAKE_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}
        run: cd terraform && terraform apply -auto-approve

